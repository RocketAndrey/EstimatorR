@page
@model Estimator.Pages.CustomerRequests.ReportModel

@{
    ViewData["Title"] = "Расчёт стоимости по заявке";
}
<form method="post">

        <
        <table class="table ">
            <tr>
                <td> <h4>Расчёт стоимости испытаний заявки&nbsp;@Model.CustomerRequest.CustomerRequestID</h4></td>
                <td align="right"><a asp-page="./Edit" asp-route-id="@Model.CustomerRequest.CustomerRequestID"><img src="~/Request.png" width="32" height="32" /></a></td>
            </tr>
        </table>


        <dl class="row">
            <dt class="col-sm-2">
                Заявка:
            </dt>
            <dd class="col-sm-10">
                @String.Concat(Model.CustomerRequest.RequestNumber, " от ", @Model.CustomerRequest.RequestDate.ToShortDateString())
            </dd>
            <dt class="col-sm-2">
                Заказчик:
            </dt>
            <dd class="col-sm-10">
                @Html.DisplayFor(model => model.CustomerRequest.Customer.Name)
            </dd>
            <dt class="col-sm-2">
                Программа испытаний:
            </dt>
            <dd class="col-sm-10">
                @Html.DisplayFor(model => model.CustomerRequest.Program.Name)
            </dd>
            <dt class="col-sm-2">
                Описание:
            </dt>
            <dd class="col-sm-10">
                @Html.DisplayFor(model => model.CustomerRequest.Description)
            </dd>
            <dt class="col-sm-2">
                Экономические показатели:
            </dt>
            <dd class="col-sm-10">
                <select asp-for="SelectedYear" class="form-control" asp-items="ViewBag.YearOfNorms"></select>
            </dd>

        </dl>
<nav>
  <div class="nav nav-tabs" id="nav-tab" role="tablist">
    <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Структура цены</a>
     <a class="nav-item nav-link" id="nav-item7-tab" data-toggle="tab" href="#nav-item7" role="tab" aria-controls="nav-item7" aria-selected="false">Общие сведения</a>
    <a class="nav-item nav-link" id="nav-item5-tab" data-toggle="tab" href="#nav-item5" role="tab" aria-controls="nav-item5" aria-selected="false">Перечень</a>
    <a class="nav-item nav-link" id="nav-item3-tab" data-toggle="tab" href="#nav-item3" role="tab" aria-controls="nav-item3" aria-selected="false">Типы</a>
    <a class="nav-item nav-link" id="nav-item2-tab" data-toggle="tab" href="#nav-item2" role="tab" aria-controls="nav-item2" aria-selected="false">Группы</a>
    <a class="nav-item nav-link" id="nav-item4-tab" data-toggle="tab" href="#nav-item4" role="tab" aria-controls="nav-item4" aria-selected="false">Операции</a>
     <a class="nav-item nav-link" id="nav-item6-tab" data-toggle="tab" href="#nav-item6" role="tab" aria-controls="nav-item6" aria-selected="false">Сводка браков</a>
   </div>
</nav>
<div class="tab-content" id="nav-tabContent">
    @*структура цены*@
     <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
        <table class=" table table-bordered">
            <tr>
                <th>№ п/п </th>
                <th>Наименование статей калькуляции </th>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <th>
                        <a asp-page="./report" asp-route-id="@Model.CustomerRequest.ParentCustomerRequestID">
                            Плановые затраты,<br /> @Model.CustomerRequest.ParentCustomerRequest.Program.Name
                        </a>
                    </th>
                }
                <th>
                    Плановые затраты,<br /> @Model.CustomerRequest.Program.Name
                </th>

                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <th>
                        <a asp-page="./report" asp-route-id="@Model.CustomerRequest.ChildCustomerRequestID  ">
                            Плановые затраты,<br /> @Model.CustomerRequest.ChildCustomerRequest.Program.Name
                        </a>
                    </th>
                }


            </tr>

            <tr>
                <td>2</td>
                <td>Затраты на оплату труда основных производственных рабочих (непосредственных исполнителей) - всего:, руб</td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ParentCustomerRequest.TotalSalary.ToString("N2")
                    </td>
                }
                <td>@Model.CustomerRequest.TotalSalary.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.TotalSalary.ToString("N2")
                    </td>
                }
            </tr>
            <tr>
                <td>2.1</td>
                <td>-основная заработная плата, руб </td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>@Model.CustomerRequest.ParentCustomerRequest.BasicSalary.ToString("N2")</td>
                }
                <td>@Model.CustomerRequest.BasicSalary.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.BasicSalary.ToString("N2")
                    </td>
                }
            </tr>
            <tr>
                <td>2.2</td>
                <td>-дополнительная заработная плата, руб (@Model.CustomerRequest.CompanyHistory.AdditionalSalary.ToString("N2")%)</td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ParentCustomerRequest.AdditionalSalary.ToString("N2")
                    </td>
                }
                <td>@Model.CustomerRequest.AdditionalSalary.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.AdditionalSalary.ToString("N2")
                    </td>
                }
            </tr>
            <tr>
                <td>6</td>
                <td>Страховые взносы на обязательное социальное страхование, руб (@Model.CustomerRequest.CompanyHistory.PensionTax.ToString("N2")%) </td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>@Model.CustomerRequest.ParentCustomerRequest.PensionTax.ToString("N2") </td>
                }
                <td>@Model.CustomerRequest.PensionTax.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td> @Model.CustomerRequest.ChildCustomerRequest.PensionTax.ToString("N2")  </td>
                }
            </tr>
            <tr>
                <td>10</td>
                <td>Общехозяйственные затраты, руб (@Model.CustomerRequest.CompanyHistory.OverHead.ToString("N2")%)</td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>@Model.CustomerRequest.ParentCustomerRequest.OverHead.ToString("N2") </td>
                }
                <td>@Model.CustomerRequest.OverHead.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.OverHead.ToString("N2")
                    </td>
                }
            </tr>
            <tr>
                <td>12</td>
                <td>Производственная себестоимость, руб</td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>@Model.CustomerRequest.ParentCustomerRequest.InputCost.ToString("N2") </td>
                }
                <td>@Model.CustomerRequest.InputCost.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.InputCost.ToString("N2")
                    </td>
                }
            </tr>
            <tr>
                <td>16</td>
                <td>Прибыль, руб (@Model.CustomerRequest.CompanyHistory.Margin.ToString("N2")%)</td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>@Model.CustomerRequest.ParentCustomerRequest.Margin.ToString("N2")  </td>
                }
                <td>@Model.CustomerRequest.Margin.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.Margin.ToString("N2")
                    </td>
                }
            </tr>
            <tr>
                <td><b>17</b></td>
                <td><b>Цена(без НДС), руб</b></td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        <b>@Model.CustomerRequest.ParentCustomerRequest.TotalCost.ToString("N2") </b>
                    </td>
                }
                <td><b>@Model.CustomerRequest.TotalCost.ToString("N2") </b></td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        <b>@Model.CustomerRequest.ChildCustomerRequest.TotalCost.ToString("N2") </b>
                    </td>
                }
            </tr>

            <tr class=" table-warning">
                @if (((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0) || ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0))
                {
                    <td></td>
                    <td><b>ИТОГО без НДС, руб</b></td>
                    <td> </td>
                    <td>
                        <b>
                            @Model.FullTotalCost.ToString("N2")
                        </b>
                    </td>


                }
            </tr>

            <tr>
                <td>18</td>
                <td>Трудоемкость, чел/час</td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>@Model.CustomerRequest.ParentCustomerRequest.TotalLabor.ToString("N2")</td>
                }
                <td>@Model.CustomerRequest.TotalLabor.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.TotalLabor.ToString("N2")
                    </td>
                }
            <tr>
                <td>19</td>
                <td>Средняя заработная плата(мес), руб</td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>@Model.CustomerRequest.ParentCustomerRequest.AverageSalary.ToString("N2") </td>
                }
                <td>@Model.CustomerRequest.AverageSalary.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.AverageSalary.ToString("N2")
                    </td>
                }
            </tr>
            <tr>
                <td>20</td>
                <td>Средняя стоимость испытаний 1 партии, руб </td>
                @if ((Model.CustomerRequest.ParentCustomerRequestID ?? 0) != 0)
                {
                    <td>@Model.CustomerRequest.ParentCustomerRequest.AveragePartCost.ToString("N2") </td>
                }
                <td>@Model.CustomerRequest.AveragePartCost.ToString("N2") </td>
                @if ((Model.CustomerRequest.ChildCustomerRequestID ?? 0) != 0)
                {
                    <td>
                        @Model.CustomerRequest.ChildCustomerRequest.AveragePartCost.ToString("N2")
                    </td>
                }
            </tr>

        </table>
       
    </div>

  @*Общие сведения*@
  <div class="tab-pane fade" id="nav-item7" role="tabpanel" aria-labelledby="nav-item7-tab">
         <table class="table table-bordered">

        <tr>
            <th>@Html.DisplayNameFor(model => model.CustomerRequest.RequestElementTypes.ToList()[0].ElementType.Name)</th>
            <th>@Html.DisplayNameFor(model => model.CustomerRequest.RequestElementTypes.ToList()[0].BatchCount)</th>
            <th>@Html.DisplayNameFor(model => model.CustomerRequest.RequestElementTypes.ToList()[0].ItemCount)</th>
            <th>@Html.DisplayNameFor(model => model.CustomerRequest.RequestElementTypes.ToList()[0].KitCount)</th>
            <th>@Html.DisplayNameFor(model => model.CustomerRequest.RequestElementTypes.ToList()[0].LaborSummary)</th>
            <th>@Html.DisplayNameFor(model => model.CustomerRequest.RequestElementTypes.ToList()[0].CostSummary)</th>

        </tr>
        <tbody>
            @foreach (var item in Model.CustomerRequest.RequestElementTypes)
            {
                @if (item.BatchCount > 0)
                {
                    <tr>
                        <td>
                            @item.ElementType.Name
                        </td>
                        <td>
                            @item.BatchCount
                        </td>
                        <td>
                            @item.ItemCount
                        </td>
                        <td>
                            @item.KitCount
                        </td>
                        <td>
                            @item.LaborSummary.ToString("N2")

                        </td>
                        <td>
                            @item.CostSummary.ToString("N2")

                        </td>


                    </tr>
                }

            }
        </tbody>
        <tfoot>

            <tr>
                <td><b>Итого:</b></td>
                <td>
                    <b>
                        @Model.CustomerRequest.TotalBanchCount
                    </b>
                </td>
                <td>
                    <b>
                        @Model.CustomerRequest.TotalItemCount
                    </b>
                </td>
                <td>
                    <b>
                        @Model.CustomerRequest.TotalKitCount
                    </b>

                </td>
                <td>
                    <b>
                        @Model.CustomerRequest.TotalLabor.ToString("N2")
                    </b>

                </td>
                <td>
                    <b>
                        @Model.CustomerRequest.TotalCost.ToString("N2")
                    </b>

                </td>
            </tr>
        </tfoot>
    </table>
  </div>
  @*перечень*@
   <div class="tab-pane fade" id="nav-item5" role="tabpanel" aria-labelledby="nav-item5-tab">
   <table class="table table-bordered">

                    <tr>
                        <th>@Html.DisplayNameFor(model => model.ElementImport.XLSXElementTypes[0].RowNum)</th>
                        <th>@Html.DisplayNameFor(model => model.ElementImport.XLSXElementTypes[0].ElementName)</th>
                        <th>@Html.DisplayNameFor(model => model.ElementImport.XLSXElementTypes[0].ElementTypeName)</th>
                        <th>@Html.DisplayNameFor(model => model.ElementImport.XLSXElementTypes[0].ElementCount)</th>
                        <th>@Html.DisplayNameFor(model => model.ElementImport.XLSXElementTypes[0].Cost)</th>
              
                    </tr>
                    @if (Model.ElementImport != null)
                    {

                        @foreach (var item in Model.ElementImport.XLSXElementTypes)
                        {
                   
                   
                            <tr>
                                <td>
                                    @item.RowNum
                                </td>
                                <td>
                                    @item.ElementName
                                </td>
                                <td>
                                    @item.ElementTypeName
                                </td>
                                <td>
                                    @item.ElementCount
                                </td>
                                <td>
                         
                                    @String.Format("{0:0.00}", item.Cost)
                                </td>
                     
                            </tr>


                        }

                    }
                </table>
  </div>
@*операции  *@
    <div class="tab-pane fade" id="nav-item4" role="tabpanel" aria-labelledby="nav-item4-tab">
   
        <table class="table table-bordered">

            <tr>
                <th>@Html.DisplayNameFor(model => model.CustomerRequest.OperationSummary[0].OperationCode)</th>
                <th>@Html.DisplayNameFor(model => model.CustomerRequest.OperationSummary[0].OperationName)</th>
                @if (Model.CustomerRequest.OperationGroups.Count > 0)
                {
                    @foreach (var itemOG in Model.CustomerRequest.OperationGroups[0].QualificationLaborSummary)
                    {
                        <th>
                            @itemOG.Name
                        </th>
                    }

                    <th>@Html.DisplayNameFor(model => model.CustomerRequest.OperationSummary[0].LaborSummary)</th>
                }
            </tr>

            @foreach (var item in Model.CustomerRequest.OperationSummary)
            {
                if (item.LaborSummary > 0)
                {
                    <tr>
                        <td>
                            @item.OperationCode
                        </td>
                        <td>
                            @item.OperationName
                        </td>
                        @foreach (var itemOG in item.QualificationLaborSummary)
                        {
                            <td>
                                @String.Format("{0:0.00}", itemOG.LaborSummary / 60)
                            </td>
                        }
                        <td>
                            @String.Format("{0:0.00}", item.LaborSummary / 60)
                        </td>
                    </tr>
                }

            }
            <tfoot>
                <tr class="thead-dark">
                    <td></td>
                    <td><b>Итого трудоёмкость,  час:</b></td>
                    @foreach (var itemOG in Model.CustomerRequest.QualificationSummary)
                    {
                        <td>
                            <b>
                                @String.Format("{0:0.00}", (itemOG.LaborSummary / 60))
                            </b>
                        </td>
                    }
                    <td>
                        <b>
                            @Model.CustomerRequest.TotalLabor.ToString("N2")
                        </b>
                    </td>
                </tr>
            </tfoot>

        </table>

  </div>
   @*по группам испытаний*@
  <div class="tab-pane fade" id="nav-item2" role="tabpanel" aria-labelledby="nav-item2-tab">
        <table class="table table-bordered">

            <tr>
                <th>@Html.DisplayNameFor(model => model.CustomerRequest.OperationGroups[0].Name)</th>
                @if (Model.CustomerRequest.OperationGroups.Count > 0)
                {
                    @foreach (var itemOG in Model.CustomerRequest.OperationGroups[0].QualificationLaborSummary)
                    {
                        <th>
                            @itemOG.Name
                        </th>
                    }

                    <th>@Html.DisplayNameFor(model => model.CustomerRequest.OperationGroups[0].LaborSummary)</th>
                }
            </tr>

            @foreach (var item in Model.CustomerRequest.OperationGroups)
            {
                if (item.LaborSummary > 0)
                {
                    <tr>
                        <td>
                            @item.Name, руб.
                            <hr>
                            час
                        </td>
                        @foreach (var itemOG in item.QualificationLaborSummary)
                        {
                            <td align="center">
                               @String.Format("{0:0.00}", itemOG.CostSummary )
                                <hr>
                                 
                                    @String.Format("{0:0.00}", itemOG.LaborSummary / 60)
                            </td>
                        }
                        <td  align="center"> 
                                @String.Format("{0:0.00}", item.CostSummary)
                            <hr>
                           
                                @String.Format("{0:0.00}", item.LaborSummary / 60)
                        </td>
                    </tr>
                }

            }
            <tfoot>
                <tr class="thead-dark">
                    <td><b>Итого трудоёмкость,  час:</b></td>
                    @foreach (var itemOG in Model.CustomerRequest.QualificationSummary)
                    {
                        <td align="center">
                            <b >
                                         @String.Format("{0:0.00}", (itemOG.CostSummary))
                            </b>
                            <hr>
                            <b>
                     
                                    @String.Format("{0:0.00}", (itemOG.LaborSummary / 60))
                            </b>
                        </td>
                    }
                    <td align="center">
                        <b>
                              @Model.CustomerRequest.TotalCost.ToString("N2")
                        </b>
                         <hr>
                            <b>
                           
                                 @Model.CustomerRequest.TotalLabor.ToString("N2")
                            </b>
                    </td>
                </tr>
            </tfoot>
        </table>
    
  </div>

  @* по типам*@
   <div class="tab-pane fade" id="nav-item3" role="tabpanel" aria-labelledby="nav-item3-tab">

 <table class="table table-bordered">

            <tr>
                <th>@Html.DisplayNameFor(model => model.CustomerRequest.RequestElementTypes.ToList()[0].ElementType.Name)</th>

                @foreach (var itemOG in Model.CustomerRequest.RequestElementTypes.ToList()[0].QualificationLaborSummary)
                {
                    <th>
                        @itemOG.Key.ToString()
                    </th>
                }

                <th>@Html.DisplayNameFor(model => model.CustomerRequest.RequestElementTypes.ToList()[0].LaborSummary)</th>

            </tr>

            @foreach (var item in Model.CustomerRequest.RequestElementTypes)
            {
                if (item.BatchCount > 0)
                {
                    <tr>
                        <td>
                            @item.ElementType.Name
                        </td>
                        @foreach (var itemQ in item.QualificationLaborSummary)
                        {
                            <td>
                                @String.Format("{0:0.00}", itemQ.Value.LaborSummary / 60)

                            </td>
                        }
                        <td>
                            @String.Format("{0:0.00}", item.LaborSummary)

                        </td>

                    </tr>
                }

            }
            <tfoot>
                <tr class="thead-dark">
                    <td><b>Итого трудоёмкость,  час:</b></td>
                    @foreach (var itemOG in Model.CustomerRequest.QualificationSummary)
                    {
                        <td>
                            <b>
                                @String.Format("{0:0.00}", (itemOG.LaborSummary / 60))
                            </b>
                        </td>
                    }
                    <td>
                        <b>
                            @Model.CustomerRequest.TotalLabor.ToString("N2")
                        </b>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
@*Сводка браков*@
   <div class="tab-pane fade" id="nav-item6" role="tabpanel" aria-labelledby="nav-item6-tab">
        <table class="table table-bordered">

            <tr>
                <th>@Html.DisplayNameFor(model => model.ElementImport.DefectedTypes[0].ProtokolNumber)</th>
                <th>@Html.DisplayNameFor(model => model.ElementImport.DefectedTypes[0].TypeNominal)</th>
                <th>@Html.DisplayNameFor(model => model.ElementImport.DefectedTypes[0].Description)</th>
                <th>@Html.DisplayNameFor(model => model.ElementImport.DefectedTypes[0].DefectCount)</th>
                <th>Тип несоответствия</th>
            </tr>
            @if (Model.ElementImport != null)
            {

                @foreach (var item in Model.ElementImport.DefectedTypes)
                {
                    string selectedRow = item.RFA ? "table-danger" : item.NormTY ? "table-warning" : "table-success";

                    string rowText = item.RFA ? "РФА" : item.NormTY ? "ТУ" : "НР";
                    <tr class=@selectedRow>
                        <td>
                            @item.ProtokolNumber
                        </td>
                        <td>
                            @item.TypeNominal
                        </td>
                        <td>
                            @item.Description
                        </td>
                        <td>
                            @item.DefectCount
                        </td>
                        <td>
                            @rowText
                        </td>
                    </tr>


                }

            }
        </table>

   </div>
</div>


    <div class="btn-group" role="group" aria-label="Basic example">
        <a asp-page="./Index" class="btn btn-outline-primary ">Список</a>
      <a asp-page="./Edit" asp-route-id="@Model.CustomerRequest.CustomerRequestID" class="btn btn-outline-primary">Редактировать</a>
    </div>
</form>
